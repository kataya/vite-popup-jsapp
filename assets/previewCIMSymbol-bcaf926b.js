import{fm as B,au as Z,fn as $,fo as z,W as A,cf as F,fp as ee,ad as te,fd as ae,fq as ie,fr as X,fl as E,cg as H,fi as re}from"./index-4b712bf9.js";import{r as ne,n as K,i as L,e as oe,G as se,V as le,Q as ce}from"./cimAnalyzer-9d4f2bda.js";import{h as he}from"./CIMResourceManager-9a9b8607.js";import{c as me}from"./Rasterizer-ddb18963.js";import"./fontUtils-06f0d4b5.js";import"./BidiEngine-9a40f2f4.js";import"./OptimizedGeometry-196224d4.js";import"./GeometryUtils-984e8446.js";import"./enums-f1a6a48a.js";import"./alignmentUtils-ae955d28.js";import"./definitions-f717827e.js";import"./number-e491b09e.js";import"./Rect-ea14f53a.js";import"./quantizationUtils-b587b411.js";import"./floatRGBA-d3873d8b.js";import"./imageutils-fc0d7e0b.js";import"./rasterizingUtils-6d388749.js";var T;(function(u){u.Legend="legend",u.Preview="preview"})(T||(T={}));const G=u=>u&&u.scaleFactor?u.scaleFactor:1,ge=96/72;class ue{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new ne,this._cimResourceManager=new he,this._rasterizer=new me(this._cimResourceManager)}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,s,a,i,n,l,r){if(!e)return null;const{data:f}=e;if(!f||f.type!=="CIMSymbolReference"||!f.symbol)return null;const{symbol:p}=f;n||(n=B(p));const d=await K.resolveSymbolOverrides(f,t,this._spatialReference,i,n,l,r);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const m=this._imageDataCanvas,h=this._cimResourceManager,y=[];L.fetchResources(d,h,y),L.fetchFonts(d,h,y),y.length>0&&await Promise.all(y);const{width:c,height:g}=s,C=fe(n,c,g,a),o=L.getEnvelope(d,C,h);if(!o)return null;const I=(window.devicePixelRatio||1)*ge;let w=1,v=0,b=0;switch(p.type){case"CIMPointSymbol":case"CIMTextSymbol":{let S=1;o.width>c&&(S=c/o.width);let k=1;o.height>g&&(k=g/o.height),a==="preview"&&(o.width<c&&(S=c/o.width),o.height<g&&(k=g/o.height)),w=Math.min(S,k),v=o.x+o.width/2,b=o.y+o.height/2}break;case"CIMLineSymbol":{let S=1;o.height>g&&(S=g/o.height),w=S,b=o.y+o.height/2;const k=o.x*w+c/2,x=(o.x+o.width)*w+c/2;if(k<0){const{paths:R}=C;R[0][0][0]-=k}if(x>c){const{paths:R}=C;R[0][2][0]-=x-c}}break;case"CIMPolygonSymbol":{v=o.x+o.width/2,b=o.y+o.height/2;const S=o.x*w+c/2,k=(o.x+o.width)*w+c/2,x=o.y*w+g/2,R=(o.y+o.height)*w+g/2,{rings:D}=C;S<0&&(D[0][0][0]-=S,D[0][3][0]-=S,D[0][4][0]-=S),x<0&&(D[0][0][1]+=x,D[0][1][1]+=x,D[0][4][1]+=x),k>c&&(D[0][1][0]-=k-c,D[0][2][0]-=k-c),R>g&&(D[0][2][1]+=R-g,D[0][3][1]+=R-g)}}m.width=c*I,m.height=g*I;const M=1;m.width+=2*M,m.height+=2*M;const _=m.getContext("2d"),P=ce.createIdentity();return P.translate(-v,-b),P.scale(w*I,-w*I),P.translate(c*I/2+M,g*I/2+M),_.clearRect(0,0,m.width,m.height),new oe(_,h,P,!0).drawSymbol(d,C),_.getImageData(0,0,m.width,m.height)}async analyzeCIMSymbol3D(e,t,s,a,i){const n=[],l=t?{geometryType:a,spatialReference:this._spatialReference,fields:t}:null,r=[];L.fetchFonts(e.data.symbol,this._cimResourceManager,r),await Promise.all(r);const f=new se(this._cimResourceManager,l);let p;await f.analyzeSymbolReference(e.data,this._avoidSDF,n),Z(i);for(const d of n)d.cim.type!=="CIMPictureMarker"&&d.cim.type!=="CIMPictureFill"&&d.cim.type!=="CIMPictureStroke"||(p||(p=[]),p.push(this._fetchPictureMarkerResource(d,i))),s&&d.type==="text"&&typeof d.text=="string"&&d.text.includes("[")&&(d.text=$(s,d.text,d.cim.textCase));return p&&await Promise.all(p),n}rasterizeCIMSymbol3D(e,t,s,a,i,n){const l=[];for(const r of e){a&&typeof a.scaleFactor=="function"&&(a.scaleFactor=a.scaleFactor(t,i,n));const f=this._getRasterizedResource(r,t,s,a,i,n);if(!f)continue;let p=0,d=f.anchorX||0,m=f.anchorY||0,h=!1,y=0,c=0;if(s==="esriGeometryPoint"){const g=G(a);if(y=z(r.offsetX,t,i,n)*g||0,c=z(r.offsetY,t,i,n)*g||0,r.type==="marker")p=z(r.rotation,t,i,n)||0,h=r.rotateClockwise??!1;else if(r.type==="text"){if(p=z(r.angle,t,i,n)||0,r.horizontalAlignment!==void 0)switch(r.horizontalAlignment){case"left":d=-.5;break;case"right":d=.5;break;default:d=0}if(r.verticalAlignment!==void 0)switch(r.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}f!=null&&l.push({angle:p,rotateClockWise:h,anchorX:d,anchorY:m,offsetX:y,offsetY:c,rasterizedResource:f})}return this.getSymbolImage(l)}getSymbolImage(e){const t=document.createElement("canvas"),s=A(t.getContext("2d"));let a=0,i=0,n=0,l=0;const r=[];for(let m=0;m<e.length;m++){const h=e[m],y=h.rasterizedResource;if(!y)continue;const c=y.size,g=h.offsetX,C=h.offsetY,o=h.anchorX,I=h.anchorY,w=h.rotateClockWise||!1;let v=h.angle,b=F(g)-c[0]*(.5+o),M=F(C)-c[1]*(.5+I),_=b+c[0],P=M+c[1];if(v){w&&(v=-v);const x=Math.sin(v*Math.PI/180),R=Math.cos(v*Math.PI/180),D=b*R-M*x,W=b*x+M*R,j=b*R-P*x,N=b*x+P*R,V=_*R-P*x,q=_*x+P*R,U=_*R-M*x,J=_*x+M*R;b=Math.min(D,j,V,U),M=Math.min(W,N,q,J),_=Math.max(D,j,V,U),P=Math.max(W,N,q,J)}a=b<a?b:a,i=M<i?M:i,n=_>n?_:n,l=P>l?P:l;const S=s.createImageData(y.size[0],y.size[1]);S.data.set(new Uint8ClampedArray(y.image.buffer));const k={offsetX:g,offsetY:C,rotateClockwise:w,angle:v,rasterizedImage:S,anchorX:o,anchorY:I};r.push(k)}t.width=n-a,t.height=l-i;const f=-a,p=l;for(let m=0;m<r.length;m++){const h=r[m],y=this._imageDataToCanvas(h.rasterizedImage),c=h.rasterizedImage.width,g=h.rasterizedImage.height,C=f-c*(.5+h.anchorX),o=p-g*(.5-h.anchorY);if(h.angle){const I=(360-h.angle)*Math.PI/180;s.save(),s.translate(F(h.offsetX),-F(h.offsetY)),s.translate(f,p),s.rotate(I),s.translate(-f,-p),s.drawImage(y,C,o),s.restore()}else s.drawImage(y,C+F(h.offsetX),o-F(h.offsetY))}const d=new ee({x:f/t.width-.5,y:p/t.height-.5});return{imageData:t.width!==0&&t.height!==0?s.getImageData(0,0,t.width,t.height):s.createImageData(1,1),anchorPosition:d}}async _fetchPictureMarkerResource(e,t){const s=e.materialHash;if(!this._pictureMarkerCache.get(s)){const a=(await te(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(s,a)}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,s=A(t.getContext("2d"));return t.width=e.width,t.height=e.height,s.putImageData(e,0,0),t}_imageTo32Array(e,t,s,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,n=A(i.getContext("2d"));if(i.width=t,i.height=s,n.drawImage(e,0,0,t,s),a){n.save();const l=new ae(a);n.fillStyle=l.toHex(),n.globalCompositeOperation="multiply",n.fillRect(0,0,t,s),n.globalCompositeOperation="destination-atop",n.drawImage(e,0,0,t,s),n.restore()}return new Uint32Array(n.getImageData(0,0,t,s).data.buffer)}_getRasterizedResource(e,t,s,a,i,n){let l,r,f;if(e.type==="text")return this._rasterizeTextResource(e,t,a,i,n);({analyzedCIM:l,hash:r}=de(e,t,i,n));const m=G(a);if(e.cim.type==="CIMPictureMarker"){const c=z(e.size,t,i,n)*m,{image:g,width:C,height:o}=A(this._getPictureResource(e,c,z(e.color,t,i,n)));return f={image:g,size:[C,o],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},f}ie(l,m,{preserveOutlineWidth:!1});const h=l;r+=s,a&&(r+=JSON.stringify(a));const y=this._resourceCache;return y.has(r)?y.get(r):(f=this._rasterizer.rasterizeJSONResource({cim:h,type:e.type,url:e.url,mosaicHash:r,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),y.set(r,f),f)}_rasterizeTextResource(e,t,s,a,i){var M,_,P;const n=G(s),l=z(e.text,t,a,i);if(!l||l.length===0)return null;const r=e.cim,f=z((r==null?void 0:r.fontFamilyName)||e.fontName,t,a,i),p=z(((M=r==null?void 0:r.font)==null?void 0:M.style)||e.style,t,a,i),d=z(((_=r==null?void 0:r.font)==null?void 0:_.weight)||e.weight,t,a,i),m=z(((P=r==null?void 0:r.font)==null?void 0:P.decoration)||e.decoration,t,a,i),h=z(e.size,t,a,i)*n,y=z(e.horizontalAlignment,t,a,i),c=z(e.verticalAlignment,t,a,i),g=X(z(e.color,t,a,i)),C=X(z(e.outlineColor,t,a,i)),o=z(e.outlineSize,t,a,i),I=e.backgroundColor!=null?X(e.backgroundColor):null,w=e.borderLineColor!=null?X(e.borderLineColor):null,v=e.borderLineWidth!=null?e.borderLineWidth:null,b={color:g,size:h,horizontalAlignment:y,verticalAlignment:c,font:{family:f,style:p,weight:d,decoration:m},halo:{size:o||0,color:C,style:p},backgroundColor:I,borderLine:w!=null&&v!=null?{color:w,size:v}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(l,b)}_getPictureResource(e,t,s){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const i=a.height/a.width,n=t?i>1?F(t):F(t)/i:a.width,l=t?i>1?F(t)*i:F(t):a.height;return{image:this._imageTo32Array(a,n,l,s),width:n,height:l}}}function fe(u,e,t,s){const i=-e/2+1,n=e/2-1,l=t/2-1,r=-t/2+1;switch(u){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[i,0],[0,0],[n,0]]]};default:return s==="legend"?{rings:[[[i,l],[n,0],[n,r],[i,r],[i,l]]]}:{rings:[[[i,l],[n,l],[n,r],[i,r],[i,l]]]}}}function de(u,e,t,s){let a,i;return typeof u.materialHash=="function"?(a=(0,u.materialHash)(e,t,s),i=le(u.cim,u.materialOverrides)):(a=u.materialHash,i=u.cim),{analyzedCIM:i,hash:a}}const Y=new ue(null,!0),O=E(H.size),Q=E(H.maxSize),ye=E(H.lineWidth),pe=1;function we(u){const e=u==null?void 0:u.size;return typeof e=="number"?{width:e,height:e}:{width:e!=null&&typeof e=="object"&&"width"in e?e.width:null,height:e!=null&&typeof e=="object"&&"height"in e?e.height:null}}async function Ye(u,e={}){var I;const{node:t,opacity:s,symbolConfig:a}=e,i=a!=null&&typeof a=="object"&&"isSquareFill"in a&&a.isSquareFill,n=e.cimOptions||e,l=n.geometryType||B((I=u==null?void 0:u.data)==null?void 0:I.symbol),r=we(e),{feature:f,fieldMap:p}=n;if(r.width==null||r.height==null){const w=await K.resolveSymbolOverrides(u.data,f,null,p,l);if(!w)return null;(u=u.clone()).data={type:"CIMSymbolReference",symbol:w},u.data.primitiveOverrides=void 0;const v=[];L.fetchResources(w,Y.resourceManager,v),L.fetchFonts(w,Y.resourceManager,v),v.length>0&&await Promise.all(v);const b=L.getEnvelope(w,null,Y.resourceManager),M=b==null?void 0:b.width,_=b==null?void 0:b.height;r.width=l==="esriGeometryPolygon"?O:l==="esriGeometryPolyline"?ye:M!=null&&isFinite(M)?Math.min(M,Q):O,r.height=l==="esriGeometryPolygon"?O:_!=null&&isFinite(_)?Math.max(Math.min(_,Q),pe):O}const d=await Y.rasterizeCIMSymbolAsync(u,f,r,i||l!=="esriGeometryPolygon"?T.Preview:T.Legend,p,l);if(!d)return null;const{width:m,height:h}=d,y=document.createElement("canvas");y.width=m,y.height=h,y.getContext("2d").putImageData(d,0,0);const c=F(r.width),g=F(r.height),C=new Image(c,g);C.src=y.toDataURL(),C.ariaLabel=e.ariaLabel??null,C.alt=e.ariaLabel??"",s!=null&&(C.style.opacity=`${s}`);let o=C;if(e.effectView!=null){const w={shape:{type:"image",x:0,y:0,width:c,height:g,src:C.src},fill:null,stroke:null,offset:[0,0]};o=re([[w]],[c,g],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return t&&o&&t.appendChild(o),o}export{Ye as previewCIMSymbol};
